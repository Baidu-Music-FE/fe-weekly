var $, all_h, content, create_div, el, find_pos, format, h_list, m, min_h, space, toc, toc_title, _i, _j, _len, _len1, _ref;

$ = function(qs, self) {
  if (self == null) {
    self = document;
  }
  return self.querySelectorAll(qs);
};

create_div = function(str) {
  var div;
  div = document.createElement('div');
  div.innerHTML = str;
  return div;
};

space = function(n) {
  var _i, _results;
  return (function() {
    _results = [];
    for (var _i = 0; 0 <= n ? _i < n : _i > n; 0 <= n ? _i++ : _i--){ _results.push(_i); }
    return _results;
  }).apply(this).map(function() {
    return '<b class="space">Â·</b>';
  }).join('');
};

format = function(h) {
  var div, n, tag;
  tag = h.tagName;
  n = +tag.match(/\d+/) - min_h;
  div = create_div("" + (space(n)) + "\n<" + tag + ">\n	" + (h.textContent.trim()) + "\n</" + tag + ">");
  $(tag, div)[0].addEventListener('click', function() {
    return h.scrollIntoView();
  });
  return div;
};

find_pos = function(obj) {
  var curtop;
  curtop = 0;
  if (obj.offsetParent) {
    while (obj = obj.offsetParent) {
      curtop += obj.offsetTop;
    }
    curtop += obj.offsetTop;
  }
  return curtop;
};

h_list = [];

all_h = $('h1, h2, h3, h4, h5, h6', $('#main')[0]);

min_h = [].slice.apply(all_h).reduce(function(m, el) {
  var n;
  n = +el.tagName.match(/h(\d)/i)[1];
  if (m < n) {
    return m;
  } else {
    return n;
  }
}, 100);

for (_i = 0, _len = all_h.length; _i < _len; _i++) {
  el = all_h[_i];
  if ((m = el.tagName.match(/h\d+/i))) {
    h_list.push(format(el));
  }
  if ((m = el.tagName.match(/ul/i))) {
    _ref = $('h4', el);
    for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
      el = _ref[_j];
      h_list.push(format(el));
    }
  }
}

toc = $('#toc')[0];

content = $('.content', toc)[0];

h_list.forEach(function(el) {
  return content.appendChild(el);
});

document.body.appendChild(toc);

toc_title = $('#toc > h1')[0];

if (localStorage.getItem('toc') === 'hide') {
  toc.style.height = '60px';
}

toc_title.addEventListener('click', function() {
  if (toc.style.height === '60px') {
    toc.style.height = null;
    return localStorage.setItem('toc', 'show');
  } else {
    localStorage.setItem('toc', 'hide');
    return toc.style.height = '60px';
  }
});
