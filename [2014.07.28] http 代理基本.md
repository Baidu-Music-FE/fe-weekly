# http 代理基本

上次说代理太抽象，这次说些具体的。

## 动机

开发中时常会需要利用代理来解决一些临时需求，尤其是搭建封闭开发环境比较耗时时。

提到开发专用代理工具，首先想到的就是 Fiddler，常见用法：

* 将远端文件和本地文件进行替换调试
* 性能测试，作为指定请求的入口点，比起用 chrome 的 network 之类的调试工具，统计的数据更可靠。
  能处理更复杂的 http 统计。比如你只想统计本站的资源，排除所有 CDN 资源。
* 制造测试用假数据。

最近我还看到了 腾讯 AlloyTeam 做的一个开源工具，Github 上 500+ 星：[livepool][0]。
这个工具是基于 Node 的，相较于 Fiddler 跨平台性更好。如果你没时间折腾高级代理，只是想转发下文件之类的，这个工具是个不错的选择。

## http 的特性

了解 http 协议是了解如何代理 http 通信的基础。http 比起通信比起用直接用 TCP socket 通信要方便很多，其中重要的一点就是 http 只有一次应答就结束，而 socket 没有限制应答次数，这直接让 socket 通信需要处理各种中途异常和状态管理。

这里只是想强调 http 一次应答的特性。它的代理也具备这个特性。

此外 http 对一次应答的描述信息异常丰富，而且描述可以扩展，而且描述都是纯文本的，通俗易懂。

## 头解析是 http 代理的关键

直接举个通俗的例子。比如你设置了系统全局的 http 请求都代理到 `127.0.0.1:8013`，代理服务 P，正在监听这个地址。
现在 Chrome 访问 `http://www.baidu.com`，Chrome 默认会使用系统设置的代理，系统会建立一个 socket 到 P，将类似如下的 http 请求头部 write 到 socket 链接里：

```
GET / HTTP/1.1
Host: www.baidu.com
Connection: keep-alive
Accept-Encoding: gzip,deflate,sdch
User-Agent: Chrome
```

P 一定需要做的事情就是先，解析这个头信息，而其中对于转发最关键的就是 `Host` 的值，P 发现 `Host` 现在为 `www.baidu.com`，于是建立跟这个地址一次完整的 http 通信，取回的数据全部吐给 Chrome，这就算完成了一次简单代理了。当然这里是为了解释方便，正真的转发工作大多数时候只是相互 pipe 数据流，我就不细说了，超出了入门范围。

从上面我们知道，虽然 http 没规定一定要有 `Host` ，但如果一个请求里没 `Host` 信息，那么代理将会无法正常工作，所以使用时要多加注意这个点。这个也和 Virtual Host 的概念相关联。

## 一个代理的实例

为了说明 http 代理是多么的简单。这里用 Node 写个例子，库用到了 [nobone][1]。

```javascript
var nb = require('nobone')();

// 只代理全部 http GET 请求
nb.service.get('*', function (req, res) {
    // 这里 url 事实上是 Node 通过 Host 等信息拼接成的。
    nb.kit.request(req.url)
    .done(function (body) {
        // 将返回的信息吐给客户端
        res.send(body);
    });
});

nb.service.listen(8013);
```

如果你 Chrome 里安装了 SwitchySharp，将全部请求代理到 8013 端口，就能工作了。这是个极其简陋的代理，所有 http `POST` 请求都会返回给 Chrome 404，所有 `GET` 请求都去除了 header 信息。

## 5 行代码实现 Fiddler 文件替换功能

```javascript
var nb = require('nobone')();

nb.service.get('st/a.js', function (req, res) {
    res.sendfile('assets/b.js');
});

nb.service.listen(8013);
```

比如在 SwitchySharp 里设置全部 `http://baidu.com/st/a.js` 代理到 8013。那么你的本地文件 `assets/b.js` 就会替换掉远端的 `http://baidu.com/st/a.js` 文件了。

## 稍复杂点的示例

```javascript
var nobone = require('nobone');
var nb = nobone({
    service: {},
    proxy: {}
});

nb.service.use(function (req, res) {
    if (req.url == 'http://baidu.com/') {
        nb.kit.request({
            url: req.url,
            headers: req.headers
        }).done(function (body) {
            // 往页面内注入一些 js helpers，比如自动页面重载库。
            // 比如还可以在某些网页注入 jquery，lodash 之类的工具，辅助调试。
            res.send(body + nobone.client());
        });
    } else {
        // 其他请求按照原样转发。
        nb.proxy.url(req, res);
    }
});

nb.service.listen(8013);
```


## 使用 PAC 来提升 Mobile 端的代理效率

PC 端代理可以用 SwitchySharp 之类的工具来控制转发，只让部分指定匹配的 url 流量发往 代理服务，其他按照正常方式请求。但 Mobile 端通常没有这么好用的工具，iOS 甚至没有权限达到这种目的。这种情况下，使用 PAC 自动代理会是不错的选择。

[0]: https://github.com/rehorn/livepool
[1]: https://github.com/ysmood/nobone

